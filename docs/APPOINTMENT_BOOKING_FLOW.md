# Appointment Booking & Management Flow - Comprehensive Healthcare Services

## üöÄ Quick Reference Guide

### üìä Implementation Status

- **Booking System**: ‚úÖ **100% Complete**
- **Attendance Management**: ‚úÖ **100% Complete**
- **Automation (Cron Jobs)**: ‚úÖ **Active**
- **Notifications**: ‚úÖ **Email Working**
- **Staff Dashboard**: ‚ùå **Missing APIs**
- **Analytics**: ‚ö†Ô∏è **Partial**

### üéØ Key APIs Ready for Use

| Endpoint                                | Purpose                | Status   |
| --------------------------------------- | ---------------------- | -------- |
| `GET /appointments/available-slots`     | T√¨m slot kh·∫£ d·ª•ng      | ‚úÖ Ready |
| `POST /appointments`                    | ƒê·∫∑t l·ªãch               | ‚úÖ Ready |
| `POST /appointments/{id}/check-in`      | Check-in b·ªánh nh√¢n     | ‚úÖ Ready |
| `POST /appointments/{id}/mark-no-show`  | ƒê√°nh d·∫•u no-show       | ‚úÖ Ready |
| `POST /appointments/{id}/late-check-in` | X·ª≠ l√Ω ƒë·∫øn tr·ªÖ (‚â§60min) | ‚úÖ Ready |

### ü§ñ Automation Features

- **Late Appointment Processing**: Cron job m·ªói 15 ph√∫t - Auto-cancel sau 60 ph√∫t
- **Reminder System**: G·ª≠i reminder 24h/2h/30min tr∆∞·ªõc
- **Resource Release**: T·ª± ƒë·ªông gi·∫£i ph√≥ng slot khi cancel/no-show
- **No-show Processing**: Manual marking v·ªõi penalty option (no auto-penalty for late)

---

## System Status Overview

### ‚úÖ **IMPLEMENTED FEATURES**

- **Core Booking System**: ƒê·∫∑t l·ªãch v·ªõi validation linh ho·∫°t
- **Attendance Management**: Check-in, no-show, late arrival v·ªõi automation
- **Status Management**: Qu·∫£n l√Ω tr·∫°ng th√°i appointment ƒë·∫ßy ƒë·ªß
- **Role-based Access**: Ph√¢n quy·ªÅn theo vai tr√≤ ng∆∞·ªùi d√πng
- **Notification System**: G·ª≠i th√¥ng b√°o cho c√°c s·ª± ki·ªán attendance
- **Auto Cron Jobs**: T·ª± ƒë·ªông ph√°t hi·ªán no-show v√† g·ª≠i reminder

### ‚ö†Ô∏è **PARTIALLY IMPLEMENTED**

- **Dashboard APIs**: C·∫ßn b·ªï sung APIs cho staff dashboard
- **Analytics**: Ch∆∞a c√≥ b√°o c√°o chi ti·∫øt v·ªÅ attendance
- **Payment Integration**: Ch∆∞a t√≠ch h·ª£p s√¢u penalty/refund v·ªõi payment

### ‚ùå **NOT IMPLEMENTED**

- **External Systems**: HMS, Queue Management integration
- **Advanced Business Rules**: Penalty theo l·ªãch s·ª≠, dynamic pricing

## Overview

H·ªá th·ªëng ƒë·∫∑t l·ªãch h·∫πn v√† qu·∫£n l√Ω attendance bao qu√°t cho c√°c c∆° s·ªü y t·∫ø v·ªõi nhi·ªÅu lo·∫°i d·ªãch v·ª•:

- **D·ªãch v·ª• t∆∞ v·∫•n**: Y√™u c·∫ßu ch·ªçn t∆∞ v·∫•n vi√™n c·ª• th·ªÉ
- **D·ªãch v·ª• x√©t nghi·ªám**: Kh√¥ng y√™u c·∫ßu t∆∞ v·∫•n vi√™n
- **D·ªãch v·ª• ki·ªÉm tra s·ª©c kh·ªèe**: Kh√¥ng y√™u c·∫ßu t∆∞ v·∫•n vi√™n
- **D·ªãch v·ª• kh√°c**: T√πy c·∫•u h√¨nh
- **Attendance Management**: Qu·∫£n l√Ω check-in, no-show, late arrival v·ªõi automation

## Service Configuration

### New Field: `requiresConsultant`

M·ªói service c√≥ field `requiresConsultant` (boolean) ƒë·ªÉ x√°c ƒë·ªãnh:

- `true`: D·ªãch v·ª• y√™u c·∫ßu ch·ªçn t∆∞ v·∫•n vi√™n (consultation, therapy)
- `false`: D·ªãch v·ª• kh√¥ng y√™u c·∫ßu t∆∞ v·∫•n vi√™n (lab test, health checkup)

## API Endpoints

### üìã **BOOKING APIs** (‚úÖ Implemented)

#### 1. GET `/appointments/available-slots` - T√¨m ki·∫øm slot kh·∫£ d·ª•ng

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: Ch·ªâ tr·∫£ v·ªÅ slot cho c√°c d·ªãch v·ª• y√™u c·∫ßu t∆∞ v·∫•n vi√™n

**Query Parameters**:

```typescript
{
  serviceIds: string[];           // Required: Danh s√°ch ID d·ªãch v·ª•
  startDate: string;             // Required: Ng√†y b·∫Øt ƒë·∫ßu t√¨m ki·∫øm (YYYY-MM-DD)
  endDate?: string;              // Optional: Ng√†y k·∫øt th√∫c (m·∫∑c ƒë·ªãnh +7 ng√†y)
  startTime?: string;            // Optional: Gi·ªù b·∫Øt ƒë·∫ßu (m·∫∑c ƒë·ªãnh 08:00)
  endTime?: string;              // Optional: Gi·ªù k·∫øt th√∫c (m·∫∑c ƒë·ªãnh 18:00)
  consultantId?: string;         // Optional: T√¨m slot cho t∆∞ v·∫•n vi√™n c·ª• th·ªÉ
}
```

**Response**:

```typescript
{
  availableSlots: AvailableSlotDto[];
  totalSlots: number;
  totalConsultants: number;
  message?: string;              // "C√°c d·ªãch v·ª• ƒë∆∞·ª£c ch·ªçn kh√¥ng y√™u c·∫ßu t∆∞ v·∫•n vi√™n."
}
```

#### 2. POST `/appointments` - ƒê·∫∑t l·ªãch h·∫πn (Flexible)

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: ƒê·∫∑t cu·ªôc h·∫πn linh ho·∫°t theo lo·∫°i d·ªãch v·ª•

**Body**:

```typescript
{
  serviceIds: string[];                    // Required: Danh s√°ch ID d·ªãch v·ª•
  consultantId?: string;                   // Optional: ID t∆∞ v·∫•n vi√™n (b·∫Øt bu·ªôc cho d·ªãch v·ª• t∆∞ v·∫•n)
  appointmentDate: Date;                   // Required: Ng√†y gi·ªù cu·ªôc h·∫πn
  appointmentLocation: LocationTypeEnum;   // Required: Online/Office
  notes?: string;                          // Optional: Ghi ch√∫
}
```

**Validation Logic**:

- N·∫øu c√≥ d·ªãch v·ª• v·ªõi `requiresConsultant = true` ‚Üí `consultantId` b·∫Øt bu·ªôc
- N·∫øu t·∫•t c·∫£ d·ªãch v·ª• ƒë·ªÅu `requiresConsultant = false` ‚Üí `consultantId` optional

### üìä **MANAGEMENT APIs** (‚úÖ Implemented)

#### 3. PATCH `/appointments/{id}/status` - C·∫≠p nh·∫≠t tr·∫°ng th√°i appointment

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: C·∫≠p nh·∫≠t tr·∫°ng th√°i appointment (Admin/Manager/Consultant only)

**Body**:

```typescript
{
  status: 'pending' | 'confirmed' | 'checked_in' | 'in_progress' | 'completed' | 'cancelled' | 'rescheduled' | 'no_show';
  meetingLink?: string;  // Optional: Link ph√≤ng h·ªçp cho t∆∞ v·∫•n online
}
```

#### 4. PATCH `/appointments/{id}/cancel` - H·ªßy appointment

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: H·ªßy appointment (Customer/Admin/Manager)

**Body**:

```typescript
{
    cancellationReason: string; // Required: L√Ω do h·ªßy l·ªãch h·∫πn
}
```

### üè• **ATTENDANCE APIs** (‚úÖ Implemented)

#### 5. POST `/appointments/{id}/check-in` - Check-in b·ªánh nh√¢n

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: Check-in b·ªánh nh√¢n t·∫°i c∆° s·ªü y t·∫ø (Staff/Admin/Manager only)

**Body**:

```typescript
{
  checkInTime?: Date;           // Optional: Th·ªùi gian check-in (m·∫∑c ƒë·ªãnh hi·ªán t·∫°i)
  notes?: string;               // Optional: Ghi ch√∫ t·ª´ l·ªÖ t√¢n
  actualServices?: string[];    // Optional: Services th·ª±c t·∫ø (c√≥ th·ªÉ kh√°c ƒë·∫∑t ban ƒë·∫ßu)
}
```

**Response**:

```typescript
{
  appointmentId: string;
  checkInTime: Date;
  estimatedWaitTime: number;    // Th·ªùi gian ch·ªù d·ª± ki·∫øn (ph√∫t)
  assignedRoom?: string;        // Ph√≤ng ƒë∆∞·ª£c ph√¢n b·ªï
  nextSteps: string[];          // H∆∞·ªõng d·∫´n b∆∞·ªõc ti·∫øp theo
  status: string;
}
```

#### 6. POST `/appointments/{id}/mark-no-show` - ƒê√°nh d·∫•u no-show

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: ƒê√°nh d·∫•u appointment l√† no-show (Staff/Admin/Manager only)

**Body**:

```typescript
{
  reason: string;               // Required: L√Ω do ƒë√°nh d·∫•u no-show
  contactAttempts?: number;     // Optional: S·ªë l·∫ßn ƒë√£ c·ªë g·∫Øng li√™n h·ªá
  notes?: string;               // Optional: Ghi ch√∫ th√™m
  applyPenalty?: boolean;       // Optional: C√≥ √°p d·ª•ng ph√≠ ph·∫°t kh√¥ng
}
```

**Response**:

```typescript
{
  appointmentId: string;
  reason: string;
  penaltyApplied: boolean;
  penaltyAmount?: number;
  notificationSent: boolean;
  status: string;
}
```

#### 7. POST `/appointments/{id}/late-check-in` - X·ª≠ l√Ω check-in tr·ªÖ

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: X·ª≠ l√Ω check-in tr·ªÖ cho appointment (Staff/Admin/Manager only)

**Body**:

```typescript
{
  actualArrivalTime: Date;      // Required: Th·ªùi gian ƒë·∫øn th·ª±c t·∫ø
  lateFee?: number;             // Optional: Ph√≠ tr·ªÖ gi·ªù (VND)
  adjustedServices?: string[];  // Optional: D·ªãch v·ª• ƒëi·ªÅu ch·ªânh do thi·∫øu th·ªùi gian
  notes?: string;               // Optional: Ghi ch√∫ v·ªÅ vi·ªác ƒë·∫øn tr·ªÖ
}
```

**Response**:

```typescript
{
  appointmentId: string;
  actualArrivalTime: Date;
  lateFee: number;
  adjustedServices: string[];
  estimatedWaitTime: number;
  status: string;
  warnings: string[];          // C·∫£nh b√°o v·ªÅ vi·ªác ƒë·∫øn tr·ªÖ
}
```

### üîç **QUERY APIs** (‚úÖ Implemented)

#### 8. GET `/appointments` - Danh s√°ch appointments (role-based)

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: L·∫•y danh s√°ch appointments v·ªõi ph√¢n quy·ªÅn theo role

**Query Parameters**:

```typescript
{
  userId?: string;              // L·ªçc theo ID kh√°ch h√†ng
  consultantId?: string;        // L·ªçc theo ID t∆∞ v·∫•n vi√™n
  status?: AppointmentStatusType; // L·ªçc theo tr·∫°ng th√°i
  fromDate?: string;            // L·ªçc t·ª´ ng√†y (YYYY-MM-DD)
  toDate?: string;              // L·ªçc ƒë·∫øn ng√†y (YYYY-MM-DD)
  page?: number;                // Trang (m·∫∑c ƒë·ªãnh 1)
  limit?: number;               // S·ªë item/trang (m·∫∑c ƒë·ªãnh 10)
}
```

#### 9. GET `/appointments/{id}` - Chi ti·∫øt appointment

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: L·∫•y chi ti·∫øt appointment v·ªõi ph√¢n quy·ªÅn

#### 10. GET `/appointments/{id}/chat-room` - Chat room c·ªßa appointment

**Status**: ‚úÖ **IMPLEMENTED**  
**Description**: L·∫•y chat room cho appointment (n·∫øu c√≥)

### üöß **MISSING APIs** (‚ö†Ô∏è Need Implementation)

#### 11. GET `/appointments/dashboard/today` - Staff dashboard h√¥m nay

**Status**: ‚ùå **NOT IMPLEMENTED**  
**Description**: Dashboard cho staff xem appointments h√¥m nay

**Proposed Response**:

```typescript
{
  totalAppointments: number;
  checkedIn: number;
  pending: number;
  noShows: number;
  appointments: AppointmentSummary[];
  waitingQueue: QueueItem[];
}
```

#### 12. GET `/appointments/dashboard/check-in-queue` - H√†ng ƒë·ª£i check-in

**Status**: ‚ùå **NOT IMPLEMENTED**  
**Description**: Danh s√°ch b·ªánh nh√¢n ƒëang ch·ªù check-in

#### 13. GET `/appointments/analytics/attendance` - B√°o c√°o attendance

**Status**: ‚ùå **NOT IMPLEMENTED**  
**Description**: Th·ªëng k√™ v·ªÅ attendance, no-show rates

## User Flows

### üéØ **Core Booking Flows** (‚úÖ All Implemented)

#### Flow 1: Ch·ªâ d·ªãch v·ª• kh√¥ng y√™u c·∫ßu t∆∞ v·∫•n vi√™n (Lab Test, Health Checkup)

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. Customer ch·ªçn serviceIds (lab tests, health checkup)
2. **Call API `POST /appointments`** m√† kh√¥ng c·∫ßn `consultantId`
3. Appointment ƒë∆∞·ª£c t·∫°o v·ªõi status CONFIRMED
4. Kh√¥ng t·∫°o chat room

#### Flow 2: Ch·ªâ d·ªãch v·ª• y√™u c·∫ßu t∆∞ v·∫•n vi√™n (Consultation)

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. Customer ch·ªçn serviceIds (consultation services)
2. **Call API `GET /appointments/available-slots`**
3. Customer ch·ªçn slot v·ªõi t∆∞ v·∫•n vi√™n
4. **Call API `POST /appointments`** v·ªõi `consultantId`
5. Validate chuy√™n m√¥n v√† availability
6. Appointment ƒë∆∞·ª£c t·∫°o v·ªõi status PENDING
7. T·∫°o chat room t·ª± ƒë·ªông

#### Flow 3: D·ªãch v·ª• h·ªón h·ª£p (Lab Test + Consultation)

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. Customer ch·ªçn serviceIds (mixed services)
2. **Call API `GET /appointments/available-slots`**
3. Customer ch·ªçn slot v·ªõi t∆∞ v·∫•n vi√™n cho ph·∫ßn consultation
4. **Call API `POST /appointments`** v·ªõi `consultantId`
5. Appointment ƒë∆∞·ª£c t·∫°o bao g·ªìm c·∫£ hai lo·∫°i d·ªãch v·ª•
6. T·∫°o chat room cho ph·∫ßn consultation

#### Flow 4: Optional Consultant Assignment

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. Customer ch·ªçn serviceIds (non-consultation services)
2. C√≥ th·ªÉ ch·ªçn `consultantId` n·∫øu mu·ªën c√≥ t∆∞ v·∫•n vi√™n theo d√µi
3. **Call API `POST /appointments`** v·ªõi ho·∫∑c kh√¥ng c√≥ `consultantId`
4. Kh√¥ng validate chuy√™n m√¥n nghi√™m ng·∫∑t

### üè• **Attendance Management Flows** (‚úÖ All Implemented)

#### Flow 5: Normal Check-in Process

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. B·ªánh nh√¢n ƒë·∫øn c∆° s·ªü y t·∫ø
2. Staff check-in qua **API `POST /appointments/{id}/check-in`**
3. System c·∫≠p nh·∫≠t status th√†nh CHECKED_IN
4. G·ª≠i notification cho consultant v√† customer
5. Estimate waiting time v√† assign room (n·∫øu c√≥)

#### Flow 6: No-show Detection and Processing

**Status**: ‚úÖ **FULLY IMPLEMENTED** (with automation)

1. **Auto Detection**: Cron job ch·∫°y m·ªói 15 ph√∫t ph√°t hi·ªán no-show
2. **Manual Marking**: Staff c√≥ th·ªÉ ƒë√°nh d·∫•u qua **API `POST /appointments/{id}/mark-no-show`**
3. System √°p d·ª•ng penalty (n·∫øu configured)
4. G·ª≠i notification th√¥ng b√°o no-show
5. Release resources v√† update availability

#### Flow 7: Late Arrival Processing

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. B·ªánh nh√¢n ƒë·∫øn tr·ªÖ
2. Staff x·ª≠ l√Ω qua **API `POST /appointments/{id}/late-check-in`**
3. System t√≠nh late fee v√† adjust services
4. C·∫≠p nh·∫≠t waiting time v√† schedule
5. G·ª≠i notification v·ªÅ vi·ªác ƒë·∫øn tr·ªÖ

#### Flow 8: Automated Reminder System

**Status**: ‚úÖ **FULLY IMPLEMENTED**

1. **Cron job** ch·∫°y m·ªói gi·ªù g·ª≠i reminder
2. G·ª≠i reminder tr∆∞·ªõc appointment 24h, 2h, 30 ph√∫t
3. Email notifications v·ªõi appointment details
4. SMS notifications (n·∫øu configured)

## Key Features

### ‚úÖ **Implemented Features**

#### Service Type Detection:

```typescript
// Trong Service entity
const needsConsultant = services.some((s) => s.requiresConsultant === true);

// Legacy support
const isConsultation = services.some(
    (s) => s.category.type === ServiceCategoryType.CONSULTATION,
);

// Final decision
const requiresConsultantValidation = needsConsultant || isConsultation;
```

#### Enhanced Validation:

- ‚úÖ **Flexible consultant requirement**: D·ª±a tr√™n `requiresConsultant` field
- ‚úÖ **Specialty matching**: Ch·ªâ ki·ªÉm tra cho services y√™u c·∫ßu consultant
- ‚úÖ **Mixed service support**: X·ª≠ l√Ω ƒë∆∞·ª£c appointment c√≥ nhi·ªÅu lo·∫°i service
- ‚úÖ **Backward compatibility**: V·∫´n support logic c≈© qua category type

#### Attendance Management Features:

- ‚úÖ **Auto Late Appointment Processing**: Cron job m·ªói 15 ph√∫t - T·ª± ƒë·ªông h·ªßy l·ªãch h·∫πn sau 60 ph√∫t
- ‚úÖ **Reminder System**: Cron job g·ª≠i reminder ƒë·ªãnh k·ª≥ (24h/2h/30min tr∆∞·ªõc)
- ‚úÖ **Penalty System**: √Åp d·ª•ng ph√≠ ph·∫°t cho no-show (manual marking only)
- ‚úÖ **Resource Management**: T·ª± ƒë·ªông release slots khi h·ªßy/no-show
- ‚úÖ **Notification System**: Email cho t·∫•t c·∫£ attendance events
- ‚úÖ **Late Check-in Processing**: Cho ph√©p check-in trong v√≤ng 60 ph√∫t (kh√¥ng ph√≠ ph·∫°t)
- ‚úÖ **Status Tracking**: ƒê·∫ßy ƒë·ªß lifecycle t·ª´ booking ƒë·∫øn completion/cancellation

#### API Security & Access Control:

- ‚úÖ **Role-based Authorization**: Ph√¢n quy·ªÅn chi ti·∫øt theo role
- ‚úÖ **JWT Authentication**: B·∫£o m·∫≠t v·ªõi JWT tokens
- ‚úÖ **Data Validation**: Validation ƒë·∫ßy ƒë·ªß v·ªõi class-validator
- ‚úÖ **Error Handling**: Exception handling v√† logging

### ‚ö†Ô∏è **Partial Features**

#### Dashboard & Analytics:

- ‚ö†Ô∏è **Staff Dashboard**: Thi·∫øu APIs cho daily dashboard
- ‚ö†Ô∏è **Attendance Analytics**: Thi·∫øu reporting chi ti·∫øt
- ‚ö†Ô∏è **Performance Metrics**: Thi·∫øu KPI tracking

#### Payment Integration:

- ‚ö†Ô∏è **Penalty Processing**: Ch∆∞a t√≠ch h·ª£p v·ªõi payment gateway
- ‚ö†Ô∏è **Refund Management**: Ch∆∞a c√≥ automated refund
- ‚ö†Ô∏è **Dynamic Pricing**: Ch∆∞a c√≥ pricing d·ª±a tr√™n demand

### ‚ùå **Missing Features**

#### External Integrations:

- ‚ùå **HMS Integration**: Hospital Management System
- ‚ùå **Queue Management**: Physical queue system
- ‚ùå **Calendar Sync**: Google Calendar, Outlook sync
- ‚ùå **SMS Gateway**: Professional SMS service

#### Advanced Business Logic:

- ‚ùå **Dynamic Penalties**: Penalty d·ª±a tr√™n l·ªãch s·ª≠
- ‚ùå **Smart Scheduling**: AI-based slot recommendations
- ‚ùå **Capacity Management**: Room/resource optimization

## Example Usage

### üìã **Booking Examples**

#### Lab Test Only:

```typescript
const appointment = await fetch('/appointments', {
    method: 'POST',
    body: JSON.stringify({
        serviceIds: ['blood-test-uuid', 'urine-test-uuid'],
        appointmentDate: '2025-06-25T09:00:00Z',
        appointmentLocation: 'OFFICE',
        // consultantId kh√¥ng c·∫ßn thi·∫øt
    }),
});
```

#### Consultation Only:

```typescript
// 1. T√¨m available slots
const slots = await fetch(
    '/appointments/available-slots?' +
        new URLSearchParams({
            serviceIds: ['nutrition-consultation-uuid'],
            startDate: '2025-06-25',
        }),
);

// 2. ƒê·∫∑t l·ªãch v·ªõi consultant
const appointment = await fetch('/appointments', {
    method: 'POST',
    body: JSON.stringify({
        serviceIds: ['nutrition-consultation-uuid'],
        consultantId: slots.availableSlots[0].consultant.id,
        appointmentDate: slots.availableSlots[0].dateTime,
        appointmentLocation: 'ONLINE',
    }),
});
```

#### Mixed Services:

```typescript
const appointment = await fetch('/appointments', {
    method: 'POST',
    body: JSON.stringify({
        serviceIds: ['blood-test-uuid', 'nutrition-consultation-uuid'],
        consultantId: 'selected-consultant-uuid', // Required v√¨ c√≥ consultation
        appointmentDate: '2025-06-25T10:00:00Z',
        appointmentLocation: 'OFFICE',
    }),
});
```

### üè• **Attendance Management Examples**

#### Check-in Patient:

```typescript
const checkInResult = await fetch('/appointments/123/check-in', {
    method: 'POST',
    body: JSON.stringify({
        checkInTime: new Date(),
        notes: 'Patient arrived on time',
        actualServices: ['blood-test-uuid'], // Optional
    }),
});
```

#### Mark No-show:

```typescript
const noShowResult = await fetch('/appointments/123/mark-no-show', {
    method: 'POST',
    body: JSON.stringify({
        reason: 'Patient did not arrive',
        contactAttempts: 2,
        applyPenalty: true,
    }),
});
```

#### Process Late Check-in:

```typescript
const lateCheckIn = await fetch('/appointments/123/late-check-in', {
    method: 'POST',
    body: JSON.stringify({
        actualArrivalTime: new Date(),
        notes: 'Patient arrived 45 minutes late - no fee applied',
        adjustedServices: ['consultation-uuid'], // Optional: if services changed
    }),
});

// Response includes warnings based on delay
{
  "appointmentId": "123",
  "actualArrivalTime": "2025-06-25T10:45:00Z",
  "lateFee": 0, // Always 0 - no late fees
  "estimatedWaitTime": 25,
  "status": "CHECKED_IN",
  "warnings": [
    "B·∫°n ƒë√£ ƒë·∫øn tr·ªÖ 45 ph√∫t",
    "Th·ªùi gian t∆∞ v·∫•n c√≥ th·ªÉ b·ªã r√∫t ng·∫Øn do ƒë·∫øn tr·ªÖ",
    "L·ªãch h·∫πn s·∫Ω b·ªã h·ªßy t·ª± ƒë·ªông n·∫øu ƒë·∫øn tr·ªÖ qu√° 60 ph√∫t"
  ]
}
```

## Current Implementation Status

### ‚úÖ **Production Ready**

- **Core Booking System**: Ho√†n thi·ªán v√† stable
- **Attendance Management**: ƒê·∫ßy ƒë·ªß t√≠nh nƒÉng v·ªõi automation
- **Notification System**: Email notifications working
- **Security & Access Control**: JWT + Role-based authorization
- **Data Validation**: Comprehensive validation v·ªõi class-validator

### üöß **Development Priority**

1. **Staff Dashboard APIs** - Urgency: High
2. **Attendance Analytics** - Urgency: Medium
3. **Payment Integration for Penalties** - Urgency: Medium
4. **SMS Notifications** - Urgency: Low
5. **External System Integration** - Urgency: Future

### üìä **System Metrics** (As of June 2025)

- **API Endpoints**: 10 implemented, 3 missing
- **User Flows**: 8 fully implemented
- **Automation**: 2 cron jobs active (no-show detection, reminders)
- **Test Coverage**: Service layer tests implemented
- **Documentation**: Comprehensive with examples

## Migration Notes

### ‚úÖ **Completed Migrations**

- ‚úÖ **Backward compatibility**: Legacy services ho·∫°t ƒë·ªông nh∆∞ c≈©
- ‚úÖ **Flexible consultant requirement**: Kh√¥ng c√≤n hardcode y√™u c·∫ßu consultant
- ‚úÖ **Better UX**: Customer bi·∫øt r√µ khi n√†o c·∫ßn ch·ªçn consultant
- ‚úÖ **Admin control**: Admin c√≥ th·ªÉ config service n√†o y√™u c·∫ßu consultant
- ‚úÖ **Attendance Management**: Ho√†n to√†n m·ªõi v·ªõi ƒë·∫ßy ƒë·ªß automation
- ‚úÖ **Status Management**: B·ªï sung c√°c status m·ªõi (CHECKED_IN, IN_PROGRESS)

### üîÑ **Ongoing Improvements**

- **Performance Optimization**: Index optimization cho query performance
- **Monitoring**: Adding metrics v√† health checks
- **Error Handling**: Enhanced error messages v√† recovery
- **Testing**: Expanding test coverage cho edge cases

### üéØ **Next Phase Goals**

1. **Staff Dashboard Implementation** (Q3 2025)
2. **Advanced Analytics Dashboard** (Q4 2025)
3. **External Systems Integration** (Q1 2026)
4. **Mobile App Support** (Q2 2026)

## Late Arrival Processing Workflow

### üïê **New Late Arrival Policy** (Updated June 2025)

**Grace Period**: 60 minutes from scheduled appointment time
**Penalty**: No late fees applied
**Auto-cancellation**: After 60 minutes with no check-in

### üìã **Late Arrival Processing Flow**

#### Scenario 1: Arrival within 60 minutes ‚úÖ

```
Patient arrives 45 minutes late:
1. Staff uses `/appointments/{id}/late-check-in` endpoint
2. System validates: 45 min < 60 min threshold ‚úÖ
3. Patient successfully checked in (no fee)
4. Warning: "Consultation time may be reduced due to late arrival"
5. Status: CHECKED_IN
6. Notification sent to relevant staff
```

#### Scenario 2: Arrival after 60 minutes ‚ùå

```
Patient arrives 70 minutes late:
1. Staff attempts `/appointments/{id}/late-check-in`
2. System validates: 70 min > 60 min threshold ‚ùå
3. Error: "Appointment was auto-cancelled due to 60+ min delay"
4. Status: CANCELLED (auto-set by cron job)
5. Patient must reschedule new appointment
```

#### Scenario 3: Auto-cancellation by system ü§ñ

```
Cron job runs every 15 minutes:
1. Finds appointments > 60 min past scheduled time
2. Status: CONFIRMED/PENDING ‚Üí CANCELLED
3. Reason: "Auto-cancelled: Arrived more than 60 minutes late"
4. Resources released automatically
5. Notification sent to patient & staff
```

### üîÑ **Status Transitions for Late Arrivals**

```mermaid
graph TD
    A[CONFIRMED/PENDING] --> B{Patient Arrives?}
    B -->|Within 60 min| C[CHECKED_IN]
    B -->|After 60 min| D[CANCELLED - Auto]
    B -->|No arrival| E[Cron Job Check]
    E -->|> 60 min past| D
    C --> F[IN_PROGRESS]
    F --> G[COMPLETED]
    D --> H[Need Reschedule]
```

### ‚ö†Ô∏è **Late Arrival Warnings System**

#### Warning Levels:

- **15-30 minutes**: "You are running late, consultation time may be affected"
- **30-45 minutes**: "Significant delay, consultation time will be reduced"
- **45-60 minutes**: "Critical delay, appointment will be auto-cancelled if you don't arrive within 60 minutes"

#### Implementation:

```typescript
const warnings = [
    lateMinutes > 15 && 'B·∫°n ƒë√£ ƒë·∫øn tr·ªÖ ${lateMinutes} ph√∫t',
    lateMinutes > 30 && 'Th·ªùi gian t∆∞ v·∫•n c√≥ th·ªÉ b·ªã r√∫t ng·∫Øn do ƒë·∫øn tr·ªÖ',
    lateMinutes > 45 && 'L·ªãch h·∫πn s·∫Ω b·ªã h·ªßy t·ª± ƒë·ªông n·∫øu ƒë·∫øn tr·ªÖ qu√° 60 ph√∫t',
].filter(Boolean);
```

### üìä **Business Impact Analysis**

#### Benefits of 60-minute policy:

- ‚úÖ **Patient-friendly**: More forgiving grace period
- ‚úÖ **Reduced complaints**: No surprise late fees
- ‚úÖ **Clear expectations**: Simple 60-minute rule
- ‚úÖ **Operational efficiency**: Auto-cancellation prevents resource waste

#### Considerations:

- ‚ö†Ô∏è **Schedule disruption**: Longer grace period may affect subsequent appointments
- ‚ö†Ô∏è **Revenue impact**: No late fees collected
- ‚ö†Ô∏è **Staff communication**: Need clear protocols for late arrivals
